---
title: "Overview"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
---

```{r warning=FALSE, message=FALSE}
library(tidyverse)
library(ggplot2)
library(plotly)
```


```{r warning=FALSE, message=FALSE}
# read in raw data "overall_df.csv"
overall_df = 
  read.csv("./data/final_df.csv") %>% 
  janitor::clean_names()
```

### An Overview of the trend of infection rates from nursing home and their located counties
(Blue Dots: Nursing home data points; Black Dots: County data points.)

#### This is to show all data points from May to September of montly infections rates from both nursing homes and their located counties. With most black dots under 10% prevalence of covid-19 each month, there is a great amount of blue dots higher than 10%, indicating the higher infection rates of nursing home than their counties.

```{r warning=FALSE, message=FALSE}
# explore the trend of infection rate
NH_infection_rate =
  overall_df %>% 
  select(month, county, county_monthly_prevalence)

County_infection_rate = 
  overall_df %>% 
  select(month, county, monthly_infection_rate)

compare_infection_rate =
ggplot() +
  geom_point(data = NH_infection_rate, aes(x = county, y = county_monthly_prevalence), color = "blue") +
  geom_point(data = County_infection_rate, aes(x = county, y = monthly_infection_rate), color = "black") +
  labs(title ="Overview of infection rates", 
       x = 'County',
       y = 'Monthly Prevalence'
  ) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
  theme(legend.position = "right") 

ggplotly(compare_infection_rate)%>% 
    layout(legend = list(orientation = "h",   # show entries horizontally
                     x = 0.3, y = -0.2))  
```

### An Overview of the trend of case fatality rates from nursing home and their located counties
(Blue Dots: Nursing home data points; Black Dots: County data points.)

#### This is to show all data points from May to September of montly case fatality rates from both nursing homes and their located counties. With most black dots close to 0% case fatality rate, there is an uneven amount of blue dots higher than 50%, indicating the higher case fatality rates of nursing home than their counties.

```{r warning=FALSE, message=FALSE}
# explore the trend of case fatality rate
NH_case_fatality_rate =
  overall_df %>% 
  select(month, county, nh_monthly_fatality_rate)

County_case_fatality_rate = 
  overall_df %>% 
  select(month, county, monthly_fatality_rate)

compare_fatality_rate =
ggplot() +
  geom_point(data = NH_case_fatality_rate, aes(x = county, y = nh_monthly_fatality_rate), color = "blue") +
  geom_point(data = County_case_fatality_rate, aes(x = county, y = monthly_fatality_rate), color = "black") +
  labs(title ="Overview of case fatality rates", 
       x = 'County',
       y = 'Monthly Fatality Rate'
  ) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
  theme(legend.position = "right") 

ggplotly(compare_fatality_rate) %>% 
    layout(legend = list(orientation = "h",   # show entries horizontally
                     x = 0.3, y = -0.2))  
```

### Trend of Infection Rate by Month

##### Here we could see that the infection rate of Covid-19 of nursing home level is significantly higher than county level especially in May and June, when the nationwide Covid-19 infection rate is apparently at its peak. In July and August, it seems this unevenness has been relieved. Into September, the infection rate of nursing home level is even lower than county level.

```{r warning=FALSE, message=FALSE}
infection_rate =
  overall_df %>% 
  select(month, county, county_monthly_prevalence, monthly_infection_rate) %>% 
  drop_na() %>% 
  group_by(month) %>% 
  summarise(
    'Nursing home level' = mean(county_monthly_prevalence),
    'County level' = mean(monthly_infection_rate)) %>% 
  pivot_longer(
    'Nursing home level':'County level',
    names_to = "level",
    values_to = "infection_rate"
               )

compare_infection_rate =
  infection_rate %>% 
  ggplot(aes(x = as.factor(month),y = infection_rate, fill = level)) +
  geom_bar(position = "dodge", stat = "identity") +
  labs(title ="Trend of Infection Rate by Month", 
       x = 'Month',
       y = 'Infection Rate'
  ) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
  theme(legend.position = "bottom") 


ggplotly(compare_infection_rate)%>% 
    layout(legend = list(orientation = "h",   # show entries horizontally
                     x = 0.3, y = -0.2))
```

### Trend of Average Infection Rates by County

##### By averaging the infection rates by month from May to September, we could see the overall trend by county of nursing home and their located counties side by side. Over half of the counties see higher infection rates in their nursing home sites. 

```{r warning=FALSE, message=FALSE}
infection_rate_2 =
  overall_df %>% 
  select(month, county, county_monthly_prevalence, monthly_infection_rate) %>% 
  drop_na() %>% 
  group_by(county) %>% 
  summarise(
    'Nursing home level' = mean(county_monthly_prevalence),
    'County level' = mean(monthly_infection_rate)) %>%  
  arrange("Nursing home level") %>%
  pivot_longer(
    'Nursing home level':'County level',
    names_to = "level",
    values_to = "infection_rate"
               ) 

compare_infection_rate_2 =
  infection_rate_2 %>% 
  ggplot(aes(y = county, x = infection_rate, fill = level)) +
  geom_bar(position = "dodge", stat = "identity") +
  labs(title ="Trend of Average Infection Rates between May and October by County", 
       x = 'County',
       y = 'Infection Rate'
  )+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 0.5)) +
  theme(legend.position = "bottom") 

ggplotly(compare_infection_rate_2)%>% 
    layout(legend = list(orientation = "h",   # show entries horizontally
                     x = 0.3, y = -0.2))

```

### Trend of Case Fatality Rate by Month

##### There is a consistently trend of case fatality rate between nursing home level and county level, with significantly higher rate in nursing homes than their located counties through May into September. 

```{r warning=FALSE, message=FALSE}
case_fatality_rate =
  overall_df %>% 
  select(month, county, nh_monthly_fatality_rate, monthly_fatality_rate) %>% 
  drop_na() %>% 
  filter(is.finite(nh_monthly_fatality_rate)) %>%
  group_by(month) %>% 
  summarise(
    'Nursing home level' = mean(nh_monthly_fatality_rate),
    'County level' = mean(monthly_fatality_rate)) %>% 
  pivot_longer(
    'Nursing home level':'County level',
    names_to = "level",
    values_to = "case_fatality_rate"
               )

compare_fatality_rate =
  case_fatality_rate %>% 
  ggplot(aes(x = as.factor(month), y = case_fatality_rate, fill = level)) +
  geom_bar(position = "dodge", stat = "identity") +
  labs(title ="Trend of Case Fatality Rate by Month", 
       x = 'Month',
       y = 'Case Fatality Rate'
  ) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
  theme(legend.position = "bottom") 


ggplotly(compare_fatality_rate)%>% 
    layout(legend = list(orientation = "h",   # show entries horizontally
                     x = 0.3, y = -0.2))
```

### Trend of Average Case Fatality Rates by County

##### By averaging the case fatality rates by month, here we could see the overall trend by county to compare the case fatality rate of Covid-19 of nursing home level and county level. Almost 90% of the counties see significantly higher case fatality rates in their nursing home sites. 

```{r warning=FALSE, message=FALSE}
case_fatality_rate_2 =
  overall_df %>% 
  select(month, county, nh_monthly_fatality_rate, monthly_fatality_rate) %>% 
  drop_na() %>% 
  filter(is.finite(nh_monthly_fatality_rate)) %>%
  group_by(county) %>% 
  summarise(
    'Nursing home level' = mean(nh_monthly_fatality_rate),
    'County level' = mean(monthly_fatality_rate)) %>% 
  pivot_longer(
    'Nursing home level':'County level',
    names_to = "level",
    values_to = "case_fatality_rate"
               )

compare_fatality_rate_2 =
  case_fatality_rate_2 %>% 
  ggplot(aes(y = county, x = case_fatality_rate, fill = level)) +
  geom_bar(position = "dodge", stat = "identity") +
  labs(title ="Trend of Average Case Fatatlity Rates between May and October by County", 
       x = 'Month',
       y = 'Case Fatality Rate'
  ) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
  theme(legend.position = "bottom") 


ggplotly(compare_fatality_rate_2)%>% 
    layout(legend = list(orientation = "h",   # show entries horizontally
                     x = 0.3, y = -0.2))
```


