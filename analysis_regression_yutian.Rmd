---
title: "Untitled"
author: "Yutian Luo"
date: "11/29/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(AER)
library(plm)
library(stargazer)
library(sjPlot)
library(sjmisc)
library(sjlabelled)
library(ggplot2)
library(gridExtra)
```

##1. Panel Data MLR

```{r}

my_data =
read_csv("./data/final_df.csv") %>%
  janitor::clean_names() %>% 
  relocate(election_result) %>% 
  mutate(
   election_result = recode(election_result, "D" = "1", "R" = "0", as.numeric = TRUE)
   ) %>% 
  
  mutate(
    nh_occupancy_rate = ifelse(nh_occupancy_rate >= 1, NA, nh_occupancy_rate)
  ) %>% 


  drop_na(nh_monthly_fatality_rate,
          staff_flu_vaccination_rate,nh_occupancy_rate) %>% 
  filter((is.finite(nh_monthly_fatality_rate)))

```


MLR model: panel data regression using backward elimination

```{r mlr models panel data}

# all potential predictors
multi_fit =
  lm(county_monthly_prevalence
     ~ election_result
     + nh_monthly_fatality_rate
     + nh_occupancy_rate
     + staff_flu_vaccination_rate
     + total_shortage_stuff_monthly
     + ventilator_dependent_unit_monthly
     + monthly_infection_rate
     + monthly_fatality_rate,
     
     data = my_data
  )
summary(multi_fit)

# backward elimination
step1 = update(multi_fit, . ~ . -nh_monthly_fatality_rate)
summary(step1)

#step2
step2 = update(step1, .~. -total_shortage_stuff_monthly)
summary(step2)

#step3
step3 = update(step2, .~. -staff_flu_vaccination_rate)
summary(step3)

# stpe4
step4 = update(step3, .~. -election_result)
summary(step4)

# step5
step5 = update(step4, .~. -nh_occupancy_rate)
summary(step5)

# diagnostics
# diagnostic MLR
layout(matrix(c(1,2,3,4),2,2)) # optional 4 graphs/page 
plot(step5)

# test heteroskedasticity
bptest(step5)

# summary table
mlr_tab1 = 
  tab_model(step5, step4, step3, step2, step1, show.p = TRUE, show.ci = FALSE)
```



# 2. Simple MLR 

MLR stepAIC

```{r}

# filter entity and states
no.na.data = 
  my_data %>% 
  na.omit() %>% 
  select(
    -county,
    -month
  )

# step AIC regression
aic_res <- lm(county_monthly_prevalence ~ ., data=no.na.data)
step_ml = step(aic_res, direction='backward')

summary(step_ml)


# diagnostics
layout(matrix(c(1,2,3,4),2,2)) # optional 4 graphs/page 
plot(step_ml)

# test heteroskedasticity
bptest(step_ml)

# summary table
mlr_tab2 = 
  tab_model(step_ml, show.p = TRUE, show.ci = FALSE)

```


